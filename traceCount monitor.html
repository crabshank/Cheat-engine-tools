 <html>
 <head>
 <style>
div.notes {
	display: inline-block;
    border: #848484;
    border-width: 1px 1px 1px;
    min-width: 10.5ch;
    border-style: outset;
    margin-right: 0.7ch;
	padding: 0.18ch;
}
span.memLink {
    text-decoration: underline;
	cursor: pointer;
    /* color: #167ac6; */
}
 </style>
 </head>
 <body>
 <title>traceCount monitor</title>
 <h1 style="text-align: center;">traceCount monitor</h1>
 <label for="revChk" style="margin-bottom: 0.47ch;display: -webkit-inline-box;">Reverse auto-check direction: <input  type="checkbox"  id="revChk" style="vertical-align: bottom;margin-bottom: 0.2ch;margin-left: 0.2ch;"></input></label><br>
 <label for="openFile1">Load file: </label><input  type="file"  id="openFile1" style="margin-left: 4px;vertical-align: top;"></input>
 <pre id="preTag"></pre>
  <style>
	input[type="checkbox"]{
		filter: hue-rotate(247deg) contrast(1.65) !important;
	}
  </style>
  <script>
  var firstDone=false;
  var isRN=true;
  var chkRev=false;
  var rvc=document.getElementById("revChk");
  const registers={};
  registers['list_regs']=[
["ST(0)",71],
["ST(1)",72],
["ST(2)",73],
["ST(3)",74],
["ST(4)",75],
["ST(5)",76],
["ST(6)",77],
["ST(7)",78],
["XMM10",{"occs":[]}],
["XMM11",{"occs":[]}],
["XMM12",{"occs":[]}],
["XMM13",{"occs":[]}],
["XMM14",{"occs":[]}],
["XMM15",{"occs":[]}],
["XMM0",{"occs":[]}],
["XMM1",{"occs":[]}],
["XMM2",{"occs":[]}],
["XMM3",{"occs":[]}],
["XMM4",{"occs":[]}],
["XMM5",{"occs":[]}],
["XMM6",{"occs":[]}],
["XMM7",{"occs":[]}],
["XMM8",{"occs":[]}],
["XMM9",{"occs":[]}],
["R10D",56],
["R10W",56],
["R10L",56],
["R10B",56],
["R11D",57],
["R11W",57],
["R11L",57],
["R11B",57],
["R12D",58],
["R12W",58],
["R12L",58],
["R12B",58],
["R13D",59],
["R13W",59],
["R13L",59],
["R13B",59],
["R14D",60],
["R14W",60],
["R14L",60],
["R14B",60],
["R15D",61],
["R15W",61],
["R15L",61],
["R15B",61],
["RAX",{"occs":[]}],
["RBX",{"occs":[]}],
["RCX",{"occs":[]}],
["RDX",{"occs":[]}],
["RDI",{"occs":[]}],
["RSI",{"occs":[]}],
["RBP",{"occs":[]}],
["RSP",{"occs":[]}],
["R10",{"occs":[]}],
["R11",{"occs":[]}],
["R12",{"occs":[]}],
["R13",{"occs":[]}],
["R14",{"occs":[]}],
["R15",{"occs":[]}],
["EAX",48],
["EBX",49],
["ECX",50],
["EDX",51],
["EDI",52],
["ESI",53],
["EBP",54],
["ESP",55],
["EIP",{"occs":[]}],
["FP0",{"occs":[]}],
["FP1",{"occs":[]}],
["FP2",{"occs":[]}],
["FP3",{"occs":[]}],
["FP4",{"occs":[]}],
["FP5",{"occs":[]}],
["FP6",{"occs":[]}],
["FP7",{"occs":[]}],
["R8D",91],
["R8W",91],
["R8L",91],
["R8B",91],
["R9D",92],
["R9W",92],
["R9L",92],
["R9B",92],
["SIL",53],
["DIL",52],
["BPL",54],
["SPL",55],
["R8",{"occs":[]}],
["R9",{"occs":[]}],
["AX",48],
["AL",48],
["AH",48],
["BX",49],
["BL",49],
["BH",49],
["CX",50],
["CL",50],
["CH",50],
["DX",51],
["DL",51],
["DH",51],
["SI",53],
["DI",52],
["BP",54],
["SP",55],
["IP",70]
];

let chkCnt=0;
let allChk=[];
let ntes=[];

function sortByArrCols(arr, colsArr, dir){
    arr.sort(sortFunction);
		function sortFunction(a, b) {
			for(let i = 0; i < arr.length; i++){
					if(a[colsArr[i]]>b[colsArr[i]]){
						return dir[i]*-1;
					}else if(a[colsArr[i]]<b[colsArr[i]]){
						return dir[i]*1;
					}else if(i==arr.length-1){
					return 0;
				}
			} 
	}
}

function chkClick(event){
	let t=event.target;
	let rg=registers['list_regs'][parseInt(t.getAttribute('reg_ix'))];
	let ocs=rg.at(-1).occs;
	let st=parseInt(t.getAttribute('occ'));
	let oc=allChk[ocs[st]];
	let flg=true;
	if(oc.checked===false){
			flg=false;
	}
	if(!chkRev){
		for(let i=st+1, len=ocs.length; i<len; i++){
			allChk[ocs[i]].checked=flg;
		}
	}else{
		for(let i=st-1; i>=0; i--){
			allChk[ocs[i]].checked=flg;
		}

	}
}

registers['list_regs_len']= registers['list_regs'].length;
const pre_el=document.getElementById('preTag');
	function proc(str){
		//console.log(str);
		let lns=[];
		let rn='';
		if(isRN){
			rn='\r\n';
			lns=str.split(/\r\n\#\d+/);
		}else{
			rn='\n';
			lns=str.split(/\n\#\d+/);
		}
		let lnl=lns.length;
		let lst=lns[lnl-1];
		let mSplt='Memory accesses index:';
		let lstSpl=lst.split(rn+mSplt);
		lns[lnl-1]=`#${lnl}${lstSpl[0]}${rn}`;
		lns[0]+=rn;
		for (let i=1; i<lnl-1; i++){
			lns[i]=`#${i+1}${lns[i]}${rn}`;
		}
		let mems=(mSplt+lstSpl[1]).split(rn);
		let memsL=mems.length;
		for (let i=0; i<memsL; i++){
			lns.push(mems[i]+rn);
		}
		lnl=lns.length;
		let insts=[];
		ntes=[];
		let memAcc=false;
		let c=0;
		for (let i=0; i<lnl; i++){
			if(memAcc===true){
				let inst=lns[i];
				let hits=inst.match(/\#\d+/g);
				if(hits!==null){
						let hl=hits.length;
						if(hl>0){
							for (let k=0; k<hl; k++){
								let hk=hits[k];
								inst=inst.split(hk).join(`<span class="memLink" title="Go to ${hk}" onclick="ntes[${hk.split('#')[1]-1}].scrollIntoView();">${hk}</span>`);
							}
							insts.push(inst);
					}
				}
			}else if(lns[i].startsWith('Memory accesses index:')){
				memAcc=true;
				insts.push(lns[i]);
				pre_el.innerHTML=insts.join('');
			}else{
				let empt=(lns[i].trim()==='')?true:false;
				let lnsi_spl =[...lns[i]];
				let out_spl =lnsi_spl;
				let regexp1 = /(?<=\-)[^\t\r]+/g;
				let mtcs_lns = [...lns[i].matchAll(regexp1)];
				let inst_spl2=[];
				if(mtcs_lns.length>0){ //match
					let regexp2 = /\s*[^\s]+\s+/g;
					let mtcs_lns2 = [...mtcs_lns[0][0].matchAll(regexp2)];
					if(mtcs_lns2.length>0){ //match
						let st=mtcs_lns[0].index+mtcs_lns2[0][0].length;
						let ed=mtcs_lns[0].index+mtcs_lns[0][0].length-1;
						let inst_spl=[];
						for (let j=st; j<=ed; j++){
							inst_spl.push(lns[i][j]);
							inst_spl2.push(lns[i][j]);
							out_spl[j]='';
						}
						inst=inst_spl.join('');
						for (let k=0; k<registers['list_regs_len']; k++){
							let ka=k;
							let rk=registers['list_regs'][k];			
							let r=rk[0];
							if(typeof(rk[1])==='number'){
								ka=rk[1];
								rk=registers['list_regs'][ka];
							}
									
							let regexp = new RegExp(r, 'ig');
							let mtcs = [...inst.matchAll(regexp)];
							if(mtcs.length>0){ //match
								for (let c=0, len=mtcs.length; c<len; c++) {
									let mtc=mtcs[c];
									let s=mtc.index;
									let d=s+mtc[0].length-1;
									if(c===0){
										let rk_obj=rk.at(-1);
										let ol=rk_obj.occs.length;
										rk_obj.occs.push(chkCnt);
										inst_spl2[s]=`<input type="checkbox" reg_ix="${ka}" ln="${c}" title="${r}" occ="${ol}" ovr_occ="${chkCnt}" onclick="chkClick(event);">`+inst_spl[s];
										inst_spl2[d]+='</input>';
										chkCnt++;
									}
									for(let n=s; n<=d; n++){
										inst_spl[n]=' '
									}
									inst=inst_spl.join('');
								}
							}
						}	
						out_spl[st]=inst_spl2.join('');
						inst=out_spl.join('');
						}
				}else{
					inst=rn+rn;
				}
				if(!empt){
					inst=`<div contenteditable="true" title="Notes" class="notes"></div>${inst}`;
					c++;
				}
				insts.push(inst);
		}
		}
		pre_el.innerHTML=insts.join('');
		ntes=[...pre_el.querySelectorAll('div.notes')];
			let ck=pre_el.getElementsByTagName('input');
			let cki=[];
		for(let k=0, len_k=ck.length;k<len_k;k++){
			let ckk=ck[k];
			cki[k]=[parseInt(ckk.getAttribute('ovr_occ')),ckk];
		}
		 sortByArrCols(cki,[0],[-1]);
		 for(let k=0, len_k=cki.length;k<len_k;k++){
			allChk[k]=cki[k][1];
		 }
			
		
	}
		
 rvc.addEventListener('input',  function () {
	 chkRev=rvc.checked;
 });
 
 document.getElementById("openFile1").addEventListener('change',  function () {
	 chkRev=rvc.checked;
	 var fr = new FileReader();
	 fr.onload = function () {
		let str = this.result;
		isRN=(str.split('\r\n').length>=str.split('\n').length)?true:false;
		if(firstDone===true){
		for (let k=0; k<registers['list_regs_len']; k++){
			let rk=registers['list_regs'][k];
			let rk_obj=rk.at(-1);
			if(typeof(rk_obj)==='object'){
				rk_obj.occs=[];
			}
		}
		chkCnt=0;
		allChk=[];
		proc(str);
		}else{
			proc(str);
			firstDone=true;
		}
		
	}
	fr.readAsText(this.files[0]);
}); 
 </script>
</body>
</html>